<%- include('partials/_header') %>
<%- include('partials/_sidebar') %>

<h1>Exercise Coach</h1>
<p style="color: var(--text-light); margin-top: -10px; margin-bottom: 30px;">
  A quick workout based on your latest mood: <strong><%= latestMood %></strong>
</p>

<div class="exercise-grid">

  <div class="card">
    <h3><%= suggestion.title %></h3>
    <p style="color: var(--text-light);"><%= suggestion.desc %></p>
    
    <img src="<%= suggestion.gif %>" alt="exercise gif" class="exercise-gif">

    <div style="margin-top: 20px;">
      
      <div class="timer-input-group">
        <input type="number" id="minutesInput" value="<%= suggestion.durationMin %>" min="1">
        <button class="btn btn-tinted" id="applyBtn">Set</button>
      </div>

      <div class="timer-clock" id="clock" style="text-align: center;">00:00</div>

      <div class="timer-progress-bar">
        <div class="timer-progress-fill" id="bar"></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn" id="startBtn">Start</button>
        <button class="btn btn-tinted" id="pauseBtn">Pause</button>
        <button class="btn btn-tinted" id="resetBtn">Reset</button>
      </div>
      <p id="statusMsg" style="margin-top: 15px; color: var(--text-light); min-height: 20px;"></p>
    </div>
  </div>

  <div>
    <div class="card exercise-stats">
      <h3>Your Stats</h3>
      <div class="stat-item">
        <span>ðŸ”¥ Current Streak</span>
        <strong><%= dayStreak %> days</strong>
      </div>
      <div class="stat-item">
        <span>ðŸ’ª Total Workouts</span>
        <strong><%= totalWorkouts %></span>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h3>Achievements</h3>
      <% if (badges.length) { %>
        <div>
          <% badges.forEach(b => { %>
            <span class="badge" style="background-color: var(--primary-bg-tint); color: var(--primary-color); font-size: 14px;"><%= b %></span>
          <% }) %>
        </div>
      <% } else { %>
        <p style="color: var(--text-light);">Complete your first workout to earn a badge!</p>
      <% } %>
    </div>
  </div>

</div>

<div class="card" style="margin-top: 20px;">
  <h3>Last 7 Days Progress</h3>
  <div class="chart-container chart-container-sm">
    <canvas id="last7Chart"></canvas>
  </div>
</div>


<audio id="bell" src="/alarm.mp3" preload="auto"></audio>

<script>
  // Timer Logic
  const bell = document.getElementById('bell');
  const clock = document.getElementById('clock');
  const bar = document.getElementById('bar');
  const statusMsg = document.getElementById('statusMsg');
  let totalSec = (<%= suggestion.durationMin %>) * 60;
  let left = totalSec;
  let t = null;
  let paused = false;

  function fmt(s) {
    const m = Math.floor(s/60);
    const sec = s % 60;
    return String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
  }
  function draw() {
    clock.textContent = fmt(left);
    const pct = Math.max(0, Math.min(100, ((totalSec - left)/totalSec)*100));
    bar.style.width = pct + '%';
  }
  function start() {
    if (t) return;
    paused = false;
    statusMsg.textContent = 'In progressâ€¦';
    t = setInterval(() => {
      if (paused) return;
      left--;
      draw();
      if (left <= 0) {
        clearInterval(t); t=null;
        bell.play();
        statusMsg.textContent = 'Completed!  Loggingâ€¦';
        fetch('/exercise/complete', {
          method:'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ exercise_key: '<%= suggestion.key %>', duration_sec: totalSec })
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            statusMsg.textContent = 'Saved  Great job!';
            setTimeout(()=> location.reload(), 800);
          } else { statusMsg.textContent = 'Save failed: ' + (data.error || 'Unknown error'); }
        })
        .catch(err => { statusMsg.textContent = 'Save failed (network error)'; });
      }
    }, 1000);
  }
  function pauseToggle() {
    if (!t) return;
    paused = !paused;
    document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
  }
  function reset() {
    if (t) { clearInterval(t); t=null; }
    left = totalSec;
    paused = false;
    document.getElementById('pauseBtn').textContent = 'Pause';
    statusMsg.textContent = '';
    draw();
  }
  function applyMinutes() {
    const minutesInput = document.getElementById('minutesInput');
    const newMinutes = parseInt(minutesInput.value, 10);
    if (!isNaN(newMinutes) && newMinutes > 0) {
      totalSec = newMinutes * 60;
      reset();
    }
  }

  document.getElementById('startBtn').addEventListener('click', start);
  document.getElementById('pauseBtn').addEventListener('click', pauseToggle);
  document.getElementById('resetBtn').addEventListener('click', reset);
  document.getElementById('applyBtn').addEventListener('click', applyMinutes);
  draw();


  // Chart Logic
  const last7ChartCtx = document.getElementById('last7Chart');
  const last7Data = <%- JSON.stringify(last7) %>;
  const labels = last7Data.map(r => new Date(r.day).toLocaleDateString('en-GB', { day:'2-digit', month:'short' }));
  const done = last7Data.map(r => r.done);
  const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
  
  new Chart(last7ChartCtx, {
    type:'bar',
    data: { 
      labels, 
      datasets: [{ 
        label:'Exercises Completed', 
        data: done,
        backgroundColor: primaryColor,
        borderRadius: 5
      }] 
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } }
    }
  });
</script>

<%- include('partials/_footer') %>